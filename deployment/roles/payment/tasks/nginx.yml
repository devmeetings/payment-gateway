---
- name: Nginx | Make sure nginx is installed (package)
  apt:
    pkg: nginx
    state: present

- name: Nginx | Install geoip
  apt:
    pkg: geoip-database
    state: present

- name: Nginx | More GEOIP
  file:
    path: /etc/nginx/geoip
    state: directory
    mode: 0755

- name: Nginx | Fetch GEOIP
  get_url:
    url: http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz
    dest: /etc/nginx/geoip/

- name: Nginx | Fetch GEOIP City
  get_url:
    url: http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz
    dest: /etc/nginx/geoip/

- name: Nginx | Unpack GeoIP
  unarchive:
    copy: no
    src: /etc/nginx/geoip/GeoIP.dat.gz
    dest: /etc/nginx/geoip/
    creates: /etc/nginx/geoip/GeoIP.dat

- name: Nginx | Unpack GeoLiteCity
  unarchive:
    copy: no
    src: /etc/nginx/geoip/GeoLiteCity.dat.gz
    dest: /etc/nginx/geoip/
    creates: /etc/nginx/geoip/GeoLiteCity.dat

- name: Nginx | Copying site
  template:
    src: nginx.config.tpl
    dest: "/etc/nginx/sites-available/{{ server_name }}"

- name: Nginx | Enabling XPlatform
  file: 
    src: "/etc/nginx/sites-available/{{ server_name }}"
    dest: "/etc/nginx/sites-enabled/{{ server_name }}" 
    state: link

- service: name=nginx state=restarted 
- service: name=nginx enabled=yes



